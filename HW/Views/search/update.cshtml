
@{
    ViewBag.Title = "update";
}

<h2>update</h2>

<html>
<body onload="loadTable()">
@using (Html.BeginForm("update", "search", FormMethod.Post))
{
    <table border="1" border-collapse="collapse" style="width:100%">
        <tr>
            <td>訂單編號</td>
            <td colspan="3"><input type="text" name="orderId" value="@ViewBag.data.OrderID"/></td>
        </tr>
        <tr>
            <td>客戶名稱</td>
            <td colspan="3">
                <select name="custName">
                    <option value="@ViewBag.CustomersCampanyId">@ViewBag.CustCompanyName</option>
                    @foreach (var item in (List<HW.Models.Customers>)ViewBag.custcompanyNameList)
                    {
                        <option value="@item.CustomerID">@item.CompanyName</option>
                    }
                </select>
            </td>
        </tr>
        <tr>
            <td>負責員工名稱</td>
            <td colspan="3">
                <select name="emp">
                    <option value="@ViewBag.EmployeeID">@ViewBag.EmployeesFirstName</option>
                    @foreach (var item in (List<HW.Models.Employees>)ViewBag.firstNameList)
                    {
                        <option value="@item.EmployeeID">@item.FirstName</option>
                    }
                </select>
            </td>
        </tr>
        <tr>
            <td>訂單日期</td>
            <td><input type="date" name="orderDate" value="@ViewBag.orderDate"/></td>
            <td>需要日期</td>
            <td><input type="date" name="requestDate" value="@ViewBag.requireDate"/></td>
        </tr>
        <tr>
            <td>出貨日期</td>
            <td colspan="3"><input type="date" name="shipDate" value="@ViewBag.shipDate"/></td>
        </tr>
        <tr>
            <td>出貨公司名稱</td>
            <td colspan="3">
                <select name="shipName">
                    <option value="@ViewBag.ShipperID">@ViewBag.ShippersCompanyName</option>
                    @foreach (var item in (List<HW.Models.Shippers>)ViewBag.shipcompanyNameList)
                    {
                        <option value="@item.ShipperID">@item.CompanyName</option>
                    }
                </select>
            </td>
        </tr>
        <tr>
            <td>運費</td>
            <td colspan="3"><input type="text" name="cost" value="@ViewBag.data.Freight"/></td>
        </tr>
        <tr>
            <td>出貨國家</td>
            <td><input type="text" name="shipcountry" value="@ViewBag.data.ShipCountry"/></td>
            <td>出貨城市</td>
            <td><input type="text" name="shipcity" value="@ViewBag.data.ShipCity"/></td>
        </tr>
        <tr>
            <td>出貨地區</td>
            <td><input type="text" name="shiparea" value="@ViewBag.data.ShipRegion"/></td>
            <td>郵遞區號</td>
            <td><input type="text" name="shipaddno" value="@ViewBag.data.ShipPostalCode"/></td>
        </tr>
        <tr>
            <td>出貨地址</td>
            <td><input type="text" name="shipaddress" value="@ViewBag.data.ShipAddress"/></td>
            <td>出貨說明</td>
            <td><input type="text" name="shipdesc" value="@ViewBag.data.ShipName"/></td>
        </tr>
        <tr>
            <td>訂單金額總計</td>
            <td colspan="3"><input type="text" name="total" /></td>
        </tr>
        <tr>
            <td></td>
            <td colspan="3">
                <input type="submit" value="存檔" />
                <a href=""><input type="button" value="刪除本筆訂單" /></a>
                <a href="/search/search"><input type="button" value="回前一頁" /></a>
            </td>
        </tr>
    </table>
}
        <br/>
        <h5>訂單明細</h5>
        <br/><br />
        <input type="button" value="+新增明細" onclick="addrow()" /><br/>
        <table  id="odetailTable" border="1" style="width:100%">
            <tr>
                <td>商品</td>
                <td>單價</td>
                <td>數量</td>
                <td>小計</td>
                <td></td>
            </tr>
        </table>    

</body>
</html>
<script type="text/javascript">
    var count = document.getElementById("odetailTable").rows.length - 1;
    function loadTable() {
        var odetailTable = document.getElementById("odetailTable");
        var tableData = odetailTable.tBodies[0];

        @foreach (var item in (List<HW.Models.OrderDetails>)ViewBag.orderDetail)
        {

            @:count++;
            @:var tr = document.createElement("tr");
            @:var product = document.createElement("td");

            //product
            @:var select = document.createElement("select");
            @:select.setAttribute("id", "product" + count);
            @:select.setAttribute("onchange", "turnProduct('product" + count + "')");//當發生改變
            @:var option = new Option("@item.Products.ProductName", "@item.Products.ProductID"); //(顯示出來的name,ID value)

            @:select.appendChild(option);

            //option其他
            foreach (var proData in (List<HW.Models.Products>)ViewBag.productData)
            {
                @:var option = new Option("@proData.ProductName", "@proData.ProductID");
                @:select.appendChild(option);
            }

            //price
            @:var price = document.createElement("td");
            @:price.innerHTML = "<input type'text' id='price" + count + "' name='price' value='@item.UnitPrice' oninput='changesubtotal("+count+")'>";

            //qty
            @:var qty = document.createElement("td");
            @:qty.innerHTML = "<input type'text' id='qty" + count + "' name='qty' value='@item.Qty' oninput='changesubtotal("+count+")'>";

            //subtotal
            @:var sum=@item.UnitPrice*@item.Qty;
            @:var subtotal = document.createElement("td");
            @:subtotal.innerHTML = "<input type'text' id='subtotal" + count + "' name='subtotal' value='"+sum+"'>";

            //cancel
            @:var cancel = document.createElement("td");
            @:var button=document.createElement("button");

            @:button.innerText="取消";
            @:button.setAttribute("id",count);
            @:button.setAttribute("onclick","delerow("+count+")");

            //由內而外，順序
            @:product.appendChild(select);
            @:cancel.appendChild(button);
            @:tr.appendChild(product); //產品
            @:tr.appendChild(price);  //單價
            @:tr.appendChild(qty);  //數量
            @:tr.appendChild(subtotal);  //小計
            @:tr.appendChild(cancel);  //取消
            @:tableData.appendChild(tr);
         }
    }
    function addrow(){
        count++;
        var odetailTable = document.getElementById("odetailTable");
        var tableData = odetailTable.tBodies[0];

        var tr = document.createElement("tr");
        var product = document.createElement("td");
        var select = document.createElement("select");
        select.setAttribute("id", "product" + count);
        select.setAttribute("onchange", "turnProduct('product" + count + "')");//當發生改變
        @foreach (var proData in (List<HW.Models.Products>)ViewBag.productData)
        {
            @:var option = new Option("@proData.ProductName", "@proData.ProductID");
            @:select.appendChild(option);
        }


        //price
        var price = document.createElement("td");
        price.innerHTML = "<input type'text' id='price" + count + "' name='price'  oninput='changesubtotal("+count+")'>";

        //qty
        var qty = document.createElement("td");
        qty.innerHTML = "<input type'text' id='qty" + count + "' name='qty'  oninput='changesubtotal("+count+")'>";

        //subtotal
        var sum=0;
        var subtotal = document.createElement("td");
        subtotal.innerHTML = "<input type'text' id='subtotal" + count + "' name='subtotal value='0'>";

        //cancel
        var cancel = document.createElement("td");
        var button=document.createElement("button");

        button.innerText="取消";
        button.setAttribute("id",count);
        button.setAttribute("onclick","delerow("+count+")");

        product.appendChild(select);
        cancel.appendChild(button);
        tr.appendChild(product); //產品
        tr.appendChild(price);  //單價
        tr.appendChild(qty);  //數量
        tr.appendChild(subtotal);  //小計
        tr.appendChild(cancel);  //取消
        tableData.appendChild(tr);
    }
    function delerow(num){
        var odetailTable = document.getElementById("odetailTable");
        if(num!=count){
            num++;
        }else{
            num=count;
        }
        odetailTable.deleteRow(num);
        count--;
    }
    //改變產品選項
    function turnProduct(selectId){
        var select= document.getElementById(selectId);

        for(var i=0;i<select.options.length;i++){
            if(select.options[i].selected){
                //console.log(select.options[i].value); 產品的ID
                turnPrice(select.options[i].value,select.id);
                break;
            }
        }
    }
    function turnPrice(productId,selectId){
        var id=selectId.substring(7);  //分割product，1
        var price=document.getElementById("price"+id);
        var qty= document.getElementById("qty"+id);
        var subtotal=document.getElementById("subtotal"+id);

        $.ajax({
            type:"GET",
            url:"/search/orderPrice",
            data:{
                productId:productId
            },
            contentType:"application/json; charset=utf-8",
            dataType:"json",
            success:function(returnPrice){
                price.value=returnPrice;
                subtotal.value=Math.round(price.value*qty.value);
            }
        })
    }

    //修改單價或數量，小計改變
    function changesubtotal(id){
        var price=document.getElementById("price"+id);
        var qty= document.getElementById("qty"+id);
        var subtotal=document.getElementById("subtotal"+id);
        subtotal.value=Math.round(price.value*qty.value);
    }


</script>